#!/bin/bash

# ============================================================================
# KRONOS SERVER - AUDITOR√çA DE SEGURIDAD COMPLETA
# ============================================================================
# Este script realiza una auditor√≠a exhaustiva de seguridad del sistema
# Kronos Server, identificando vulnerabilidades y proporcionando
# recomendaciones de correcci√≥n.
#
# Ejecutar como: ./security-audit.sh
# ============================================================================

# Configuraci√≥n
REPORT_FILE="/home/mloco/kronos-server/security-audit-$(date +%Y%m%d-%H%M%S).txt"
BASE_DIR="/home/mloco/kronos-server"

# Colores para output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Contadores de vulnerabilidades
CRITICAL=0
HIGH=0
MEDIUM=0
LOW=0
INFO=0

# Funci√≥n de logging
log() {
    echo -e "$(date '+%Y-%m-%d %H:%M:%S') - $1" | tee -a "$REPORT_FILE"
}

# Funci√≥n para reportar vulnerabilidades
report_vulnerability() {
    local severity=$1
    local title=$2
    local description=$3
    local recommendation=$4
    local affected=$5

    case $severity in
        "CRITICAL")
            ((CRITICAL++))
            echo -e "${RED}üî¥ CR√çTICA${NC}" | tee -a "$REPORT_FILE"
            ;;
        "HIGH")
            ((HIGH++))
            echo -e "${RED}üü† ALTA${NC}" | tee -a "$REPORT_FILE"
            ;;
        "MEDIUM")
            ((MEDIUM++))
            echo -e "${YELLOW}üü° MEDIA${NC}" | tee -a "$REPORT_FILE"
            ;;
        "LOW")
            ((LOW++))
            echo -e "${BLUE}üîµ BAJA${NC}" | tee -a "$REPORT_FILE"
            ;;
        "INFO")
            ((INFO++))
            echo -e "${CYAN}‚ÑπÔ∏è  INFO${NC}" | tee -a "$REPORT_FILE"
            ;;
    esac

    echo "T√≠tulo: $title" | tee -a "$REPORT_FILE"
    echo "Descripci√≥n: $description" | tee -a "$REPORT_FILE"
    echo "Afectado: $affected" | tee -a "$REPORT_FILE"
    echo "Recomendaci√≥n: $recommendation" | tee -a "$REPORT_FILE"
    echo "----------------------------------------" | tee -a "$REPORT_FILE"
}

# Funci√≥n para verificar privilegios de contenedores
check_container_privileges() {
    log "${BLUE}üîç Verificando privilegios de contenedores...${NC}"

    # Contenedores con --privileged
    local privileged_containers=$(docker ps --format "table {{.Names}}\t{{.Image}}" | grep -v NAMES | while read name image; do
        if docker inspect "$name" | grep -q '"Privileged": true'; then
            echo "$name ($image)"
        fi
    done)

    if [ -n "$privileged_containers" ]; then
        report_vulnerability "CRITICAL" "Contenedores con privilegios excesivos" \
            "Los siguientes contenedores ejecutan con --privileged, lo que les da acceso completo al host" \
            "Remover --privileged de docker-compose.yml y usar capabilities espec√≠ficas si son necesarias" \
            "$privileged_containers"
    fi

    # Contenedores con capabilities peligrosas
    local dangerous_caps=$(docker ps -q | xargs docker inspect | jq -r '.[] | select(.HostConfig.CapAdd != null) | .Name + ": " + (.HostConfig.CapAdd | join(", "))' 2>/dev/null | grep -E "(NET_ADMIN|SYS_ADMIN|SYS_PTRACE)" | sed 's|^/||')

    if [ -n "$dangerous_caps" ]; then
        report_vulnerability "HIGH" "Capabilities peligrosas detectadas" \
            "Contenedores con capabilities que pueden comprometer la seguridad del sistema" \
            "Revisar y remover capabilities innecesarias como NET_ADMIN, SYS_ADMIN, SYS_PTRACE" \
            "$dangerous_caps"
    fi
}

# Funci√≥n para verificar configuraciones de red
check_network_security() {
    log "${BLUE}üîç Verificando configuraci√≥n de red...${NC}"

    # Puertos expuestos sin restricciones
    local exposed_ports=$(docker ps --format "table {{.Names}}\t{{.Ports}}" | grep -v NAMES | grep "0.0.0.0:" | wc -l)

    if [ "$exposed_ports" -gt 0 ]; then
        report_vulnerability "MEDIUM" "Puertos expuestos p√∫blicamente" \
            "Se encontraron $exposed_ports contenedores con puertos expuestos a todas las interfaces (0.0.0.0)" \
            "Configurar bind mounts espec√≠ficos o usar redes internas cuando sea posible" \
            "Verificar: docker ps --format 'table {{.Names}}\t{{.Ports}}'"
    fi

    # Verificar si hay contenedores en host network
    local host_network_containers=$(docker ps --filter "network=host" --format "{{.Names}}" | wc -l)

    if [ "$host_network_containers" -gt 0 ]; then
        local host_containers=$(docker ps --filter "network=host" --format "{{.Names}}")
        report_vulnerability "HIGH" "Contenedores usando red host" \
            "Contenedores ejecut√°ndose en modo host network tienen acceso directo a la red del host" \
            "Usar redes bridge espec√≠ficas con IPs controladas cuando sea posible" \
            "$host_containers"
    fi
}

# Funci√≥n para verificar archivos sensibles
check_sensitive_files() {
    log "${BLUE}üîç Verificando archivos sensibles...${NC}"

    # Archivos .env
    local env_files=$(find "$BASE_DIR" -name "*.env*" -type f 2>/dev/null | wc -l)

    if [ "$env_files" -gt 0 ]; then
        local env_list=$(find "$BASE_DIR" -name "*.env*" -type f 2>/dev/null)
        report_vulnerability "HIGH" "Archivos de entorno encontrados" \
            "Se encontraron archivos .env que pueden contener credenciales sensibles" \
            "Asegurar que los archivos .env est√©n en .gitignore y tengan permisos restrictivos (600)" \
            "$env_list"
    fi

    # Archivos con contrase√±as
    local password_files=$(grep -r -l "PASSWORD\|SECRET\|KEY" "$BASE_DIR" --include="*.yml" --include="*.yaml" --include="*.sh" 2>/dev/null | grep -v ".git" | wc -l)

    if [ "$password_files" -gt 0 ]; then
        local pwd_list=$(grep -r -l "PASSWORD\|SECRET\|KEY" "$BASE_DIR" --include="*.yml" --include="*.yaml" --include="*.sh" 2>/dev/null | grep -v ".git")
        report_vulnerability "MEDIUM" "Credenciales en archivos de configuraci√≥n" \
            "Se encontraron posibles credenciales en archivos de configuraci√≥n" \
            "Usar variables de entorno o Docker secrets para manejar credenciales sensibles" \
            "$pwd_list"
    fi

    # Permisos de archivos
    local world_writable=$(find "$BASE_DIR" -type f -perm -002 2>/dev/null | grep -v ".git" | wc -l)

    if [ "$world_writable" -gt 0 ]; then
        report_vulnerability "MEDIUM" "Archivos con permisos excesivos" \
            "Se encontraron archivos escribibles por cualquier usuario" \
            "Establecer permisos m√°s restrictivos (644 para archivos, 755 para directorios)" \
            "$world_writable archivos encontrados"
    fi
}

# Funci√≥n para verificar configuraciones de Traefik
check_traefik_security() {
    log "${BLUE}üîç Verificando configuraci√≥n de Traefik...${NC}"

    # Verificar si Traefik est√° ejecut√°ndose
    if docker ps --filter "name=traefik" --filter "status=running" | grep -q traefik; then
        # Verificar configuraci√≥n HTTPS
        local traefik_config=$(docker exec traefik traefik version 2>/dev/null)
        if [ $? -eq 0 ]; then
            # Verificar routers sin TLS
            local http_routers=$(docker logs traefik 2>&1 | grep -c "http://" | tail -1)
            if [ "$http_routers" -gt 0 ]; then
                report_vulnerability "MEDIUM" "Routers HTTP sin encriptaci√≥n" \
                    "Se detectaron routers HTTP sin configuraci√≥n TLS" \
                    "Configurar TLS para todos los routers o usar redirects HTTP->HTTPS" \
                    "Traefik configuration"
            fi
        fi
    else
        report_vulnerability "HIGH" "Traefik no est√° ejecut√°ndose" \
            "El proxy reverso Traefik no est√° activo, dejando servicios potencialmente expuestos" \
            "Verificar estado de Traefik y reiniciar si es necesario" \
            "Servicio Traefik"
    fi
}

# Funci√≥n para verificar versiones de im√°genes
check_image_versions() {
    log "${BLUE}üîç Verificando versiones de im√°genes Docker...${NC}"

    # Im√°genes usando latest
    local latest_images=$(docker images --format "{{.Repository}}:{{.Tag}}" | grep ":latest$" | wc -l)

    if [ "$latest_images" -gt 0 ]; then
        local latest_list=$(docker images --format "{{.Repository}}:{{.Tag}}" | grep ":latest$")
        report_vulnerability "MEDIUM" "Im√°genes usando tag 'latest'" \
            "Se encontraron $latest_images im√°genes usando el tag 'latest', lo que puede causar actualizaciones inesperadas" \
            "Especificar versiones fijas en docker-compose.yml para mayor predictibilidad" \
            "$latest_list"
    fi

    # Verificar im√°genes con vulnerabilidades conocidas (b√°sico)
    local old_images=$(docker images --format "{{.Repository}}:{{.Tag}} {{.CreatedSince}}" | grep -E "(weeks|months|years)" | wc -l)

    if [ "$old_images" -gt 0 ]; then
        report_vulnerability "LOW" "Im√°genes antiguas detectadas" \
            "Se encontraron im√°genes creadas hace semanas/meses, pueden tener vulnerabilidades conocidas" \
            "Actualizar im√°genes regularmente usando el script update-all.sh" \
            "$old_images im√°genes antiguas encontradas"
    fi
}

# Funci√≥n para verificar configuraci√≥n de Docker
check_docker_configuration() {
    log "${BLUE}üîç Verificando configuraci√≥n de Docker...${NC}"

    # Verificar si Docker est√° ejecut√°ndose con user namespace
    if docker info 2>/dev/null | grep -q "userns"; then
        log "${GREEN}‚úÖ User namespaces habilitados${NC}"
    else
        report_vulnerability "MEDIUM" "User namespaces no habilitados" \
            "Docker no est√° usando user namespaces, lo que puede afectar el aislamiento" \
            "Considerar habilitar user namespaces en daemon.json" \
            "Configuraci√≥n de Docker daemon"
    fi

    # Verificar logging driver
    local log_driver=$(docker info --format "{{.LoggingDriver}}")
    if [ "$log_driver" = "json-file" ]; then
        report_vulnerability "LOW" "Logging driver b√°sico" \
            "Usando json-file logging que puede consumir mucho espacio en disco" \
            "Considerar configurar l√≠mites de log o usar logrotate" \
            "Docker logging configuration"
    fi
}

# Funci√≥n para verificar servicios cr√≠ticos
check_critical_services() {
    log "${BLUE}üîç Verificando servicios cr√≠ticos...${NC}"

    # Verificar Pi-hole
    if ! docker ps --filter "name=pihole" --filter "status=running" | grep -q pihole; then
        report_vulnerability "HIGH" "Pi-hole no est√° ejecut√°ndose" \
            "El servidor DNS Pi-hole no est√° activo, afectando resoluci√≥n de nombres" \
            "Verificar estado de Pi-hole y reiniciar si es necesario" \
            "Servicio Pi-hole"
    fi

    # Verificar servicios con bases de datos
    local db_services=("immich_postgres" "alugueis_postgres")
    for service in "${db_services[@]}"; do
        if ! docker ps --filter "name=$service" --filter "status=running" | grep -q "$service"; then
            report_vulnerability "HIGH" "Servicio de base de datos detenido" \
                "El servicio de base de datos $service no est√° ejecut√°ndose" \
                "Verificar estado y reiniciar el servicio afectado" \
                "$service"
        fi
    done
}

# Funci√≥n para verificar backups
check_backup_configuration() {
    log "${BLUE}üîç Verificando configuraci√≥n de backups...${NC}"

    # Verificar existencia de scripts de backup
    local backup_scripts=$(find "$BASE_DIR/scripts" -name "*backup*" -type f 2>/dev/null | wc -l)

    if [ "$backup_scripts" -lt 3 ]; then
        report_vulnerability "MEDIUM" "Scripts de backup insuficientes" \
            "Se encontraron pocos scripts de backup ($backup_scripts), riesgo de p√©rdida de datos" \
            "Implementar backups autom√°ticos para bases de datos y configuraciones" \
            "Directorio scripts/"
    fi

    # Verificar permisos de scripts de backup
    local executable_scripts=$(find "$BASE_DIR/scripts" -name "*backup*" -type f -executable 2>/dev/null | wc -l)

    if [ "$executable_scripts" -lt "$backup_scripts" ]; then
        report_vulnerability "LOW" "Scripts de backup sin permisos de ejecuci√≥n" \
            "Algunos scripts de backup no tienen permisos de ejecuci√≥n" \
            "Establecer permisos 755 en scripts de backup" \
            "Scripts en $BASE_DIR/scripts/"
    fi
}

# Funci√≥n principal
main() {
    log "${PURPLE}üîí INICIANDO AUDITOR√çA DE SEGURIDAD - KRONOS SERVER${NC}"
    log "Report file: $REPORT_FILE"
    log "Base directory: $BASE_DIR"
    log "Timestamp: $(date)"
    log "================================================================================\n"

    # Verificar prerrequisitos
    if ! docker info >/dev/null 2>&1; then
        log "${RED}‚ùå ERROR: Docker no est√° ejecut√°ndose${NC}"
        exit 1
    fi

    if [ ! -d "$BASE_DIR" ]; then
        log "${RED}‚ùå ERROR: Directorio base $BASE_DIR no encontrado${NC}"
        exit 1
    fi

    # Ejecutar verificaciones
    check_container_privileges
    check_network_security
    check_sensitive_files
    check_traefik_security
    check_image_versions
    check_docker_configuration
    check_critical_services
    check_backup_configuration

    # Resumen final
    log "\n================================================================================
${PURPLE}üìä RESUMEN DE AUDITOR√çA DE SEGURIDAD${NC}"
    log "================================================================================
${RED}üî¥ Vulnerabilidades CR√çTICAS: $CRITICAL${NC}"
    log "${RED}üü† Vulnerabilidades ALTAS: $HIGH${NC}"
    log "${YELLOW}üü° Vulnerabilidades MEDIAS: $MEDIUM${NC}"
    log "${BLUE}üîµ Vulnerabilidades BAJAS: $LOW${NC}"
    log "${CYAN}‚ÑπÔ∏è  Informaci√≥n: $INFO${NC}"

    local total=$((CRITICAL + HIGH + MEDIUM + LOW + INFO))

    if [ $total -eq 0 ]; then
        log "\n${GREEN}üéâ ¬°FELICITACIONES! No se encontraron vulnerabilidades de seguridad.${NC}"
    elif [ $CRITICAL -eq 0 ] && [ $HIGH -eq 0 ]; then
        log "\n${GREEN}‚úÖ Sistema relativamente seguro. Solo vulnerabilidades menores encontradas.${NC}"
    else
        log "\n${RED}‚ö†Ô∏è  Se encontraron vulnerabilidades importantes que requieren atenci√≥n inmediata.${NC}"
    fi

    log "\nüìÑ Reporte completo guardado en: $REPORT_FILE"
    log "================================================================================\n"
}

# Ejecutar auditor√≠a
main "$@"